/* 2020-10-30 18:04 */ function XF_CANVAS(a,b){this._init(a,b),_xfx.islistviewtemplate(this,b)||(this._prop(b),this._box())}XF_CANVAS.prototype._init=function(a,b){_xfx.init(this,a,XFD_OBJKIND_CONTROL,XFD_CTRLKIND_CANVAS,b),this.css_arr=[],this.css_canvas=[],this.prev_x=0,this.prev_y=0,this.is_mouse_down=!1,this.img_curCanvas=new Image,this.img_curCanvas2=new Image,this.img_size=0,this.img_horzalign=0,this.img_vertalign=0,this.history={undo_limit:20,redo_list:[],undo_list:[],saveHistory:function(a,b,c){c=c||!1,c||(this.redo_list=[],0!=this.undo_limit&&this.undo_list.length==this.undo_limit&&this.undo_list.shift()),(b||this.undo_list).push(a.toDataURL("image/png",1))},undo:function(a,b){this.restoreHistory(a,b,this.undo_list,this.redo_list)},redo:function(a,b){this.restoreHistory(a,b,this.redo_list,this.undo_list)},restoreHistory:function(a,b,c,d){if(c.length){this.saveHistory(a,d,!0);var e=c.pop(),f=new Image;f.src=e,f.onload=function(){b.save(),b.globalCompositeOperation="copy",b.clearRect(0,0,a.width,a.height),b.drawImage(f,0,0,a.width,a.height,0,0,a.width,a.height),b.restore()}}}}},XF_CANVAS.prototype._prop=function(a){this.xf_prop={style:"",back_color:[255,255,255],border:1,border_width:0,border_color:[180,180,180],transparent:!1,back_image:"",back_imagesize:0,back_imagehorzalign:0,back_imagevertalign:0,line_width:1,line_style:0,line_color:[0,0,0],arrow_style:0,eraser_width:6,enable:!0,hidden:!1,click_setfocus:!1,draw_mode:0,undo_limit:20},this.event_name_arr=["on_click","on_saveimage"],_xfx.propcommon(this,this.xf_prop,300,200),_xfx.propparam(this,this.xf_prop,a),this._css(a),this._css_canvas(a),this.history.undo_limit=this.xf_prop.undo_limit},XF_CANVAS.prototype._css=function(a){1!=_xf_htmlready_mode&&_xfx.propcss(this,a,this.css_arr,["position","hidden"])},XF_CANVAS.prototype._css_canvas=function(a){1!=_xf_htmlready_mode&&(_xfx.propcss(this,a,this.css_canvas,["width","height","border","border_color","border_width","back_image","back_imagefillstyle","back_imagesize"]),_xfx.propbackimagepos(this,a,this.css_canvas),_xfx.propbackcolor(this,a,this.css_canvas))},XF_CANVAS.prototype._box=function(){var a;0==_xf_htmlready_mode&&(a=[],a.push("<div"),a.push(' id="'+this.xf_prop.internal_name+'"'),a.push(' class="'+_xfx.propclass(this,this.xf_prop,"_xf_canvas")+'"'),a.push(' style="'),a.push(this.css_arr.join("")),_xfx.sizeposcss(this,this.xf_prop,a),a.push('">'),a.push('<canvas class="_xf_canvas_canvas"'),a.push(' width="'+_xfu.px(this.xf_prop.width)+'"'),a.push(' height="'+_xfu.px(this.xf_prop.height)+'"'),a.push(' style="'),a.push(this.css_canvas.join("")),a.push('">'),a.push("</canvas>"),a.push("</div>")),_xfx.register(this,!1,a)},XF_CANVAS.prototype._dom=function(){this.xf_canvas=this.xf_object.children("._xf_canvas_canvas")},XF_CANVAS.prototype._offevent=function(){_xfj.offevent(this.xf_canvas,["click","mousedown","mousemove","mouseup","mouseleave"]),_xfj.offevent(this.xf_canvas,["touchstart","touchmove","touchend"])},XF_CANVAS.prototype._event=function(){this.xf_canvas.on("click",$.proxy(this.on_object_click,this)),this.xf_canvas.on("mousedown",$.proxy(this.on_object_mousedown,this)),this.xf_canvas.on("mousemove",$.proxy(this.on_object_mousemove,this)),this.xf_canvas.on("mouseup",$.proxy(this.on_object_mouseup,this)),this.xf_canvas.on("mouseleave",$.proxy(this.on_object_mouseleave,this)),this.xf_canvas.on("touchstart",$.proxy(this.on_object_mousedown,this)),this.xf_canvas.on("touchmove",$.proxy(this.on_object_mousemove,this)),this.xf_canvas.on("touchend",$.proxy(this.on_object_mouseup,this))},XF_CANVAS.prototype._create=function(){this._dom(),this._event(),this._setdrawinfo()},XF_CANVAS.prototype._setdrawinfo=function(){var a,b,c=[[],[10,3],[5,5],[8,8,4,8],[8,6,4,3,4,6]],d=["source-over","source-over","source-over","destination-out"];switch(a=this.xf_canvas.get(0),b=a.getContext("2d"),b.fillStyle=_xfu.rgbfunc(this.xf_prop.line_color),b.strokeStyle=_xfu.rgbfunc(this.xf_prop.line_color),b.globalCompositeOperation=d[this.xf_prop.draw_mode],this.xf_prop.draw_mode){case 1:b.setLineDash(c[0]),b.lineWidth=this.xf_prop.line_width,this.xf_prop.enable=!0;break;case 2:b.setLineDash(c[this.xf_prop.line_style]),b.lineWidth=this.xf_prop.line_width,this.xf_prop.enable=!0;break;case 3:b.setLineDash(c[0]),b.lineWidth=this.xf_prop.eraser_width,this.xf_prop.enable=!0;break;default:b.setLineDash(c[this.xf_prop.line_style]),b.lineWidth=this.xf_prop.line_width,this.xf_prop.enable=!1}b.save()},XF_CANVAS.prototype._drawline=function(a,b,c){var d;d=this.xf_canvas.get(0).getContext("2d"),d.beginPath(),c?d.fillRect(a-d.lineWidth/2,b-d.lineWidth/2,d.lineWidth,d.lineWidth):(d.moveTo(this.prev_x,this.prev_y),d.lineTo(a,b),d.closePath(),d.stroke()),this.prev_x=a,this.prev_y=b},XF_CANVAS.prototype._drawstraight=function(a,b,c){var d;d=this.xf_canvas.get(0).getContext("2d"),this._restore(this.img_curCanvas),d.save(),c&&(d.globalAlpha=.2),d.beginPath(),d.moveTo(this.prev_x,this.prev_y),d.lineTo(a,b),d.stroke(),this._drawarrow(this.prev_x,this.prev_y,a,b,!0),d.restore()},XF_CANVAS.prototype._drawarrow=function(a,b,c,d,e){var f,g,h,i,j,k,l;0!=this.xf_prop.arrow_style&&(f=5,g=12,h=c-a,i=d-b,j=Math.atan2(i,h),k=Math.sqrt(h*h+i*i),l=this.xf_canvas.get(0).getContext("2d"),l.save(),l.translate(a,b),l.rotate(j),l.beginPath(),1!=this.xf_prop.arrow_style&&3!=this.xf_prop.arrow_style||(l.moveTo(k-g,-f),l.lineTo(k,0),l.lineTo(k-g,f),l.lineTo(k-g,-f),l.lineTo(k,0)),2!=this.xf_prop.arrow_style&&3!=this.xf_prop.arrow_style||(l.moveTo(g,-f),l.lineTo(0,0),l.lineTo(g,f),l.lineTo(g,-f),l.lineTo(0,0)),1==e&&l.fill(),l.stroke(),l.setTransform(1,0,0,1,0,0),l.restore())},XF_CANVAS.prototype._drawimage=function(a,b,c,d){var e,f;e=this,f=new Image,"data"!=a.substr(0,4)?f.src="data:image/*;base64,"+a:f.src=a,f.onload=function(){e._drawimageobj(f,b,c,d,"source-over")}},XF_CANVAS.prototype._drawimageobj=function(a,b,c,d,e){var f,g,h,i;f=this.xf_canvas.get(0),g=f.getContext("2d"),g.save(),g.globalCompositeOperation=e,0==b?(h=1==c?_xfu["int"](f.width)/2-_xfu["int"](a.width)/2:2==c?_xfu["int"](f.width)-_xfu["int"](a.width):0,i=1==d?_xfu["int"](f.height)/2-_xfu["int"](a.height)/2:2==d?_xfu["int"](f.height)-_xfu["int"](a.height):0,g.drawImage(a,h,i)):g.drawImage(a,0,0,f.width,f.height),g.restore()},XF_CANVAS.prototype._drawbackground=function(a){var b,c;b=this.xf_canvas.get(0),c=b.getContext("2d"),c.save(),c.globalCompositeOperation="destination-over",null!=a&&this._drawimageobj(a,this.xf_prop.back_imagesize,this.xf_prop.back_imagehorzalign,this.xf_prop.back_imagevertalign,c.globalCompositeOperation),c.fillStyle=_xfu.rgbfunc(this.xf_prop.back_color),c.fillRect(0,0,b.width,b.height),factory._fireevent({xf_component:this,event_name:"on_saveimage"},this,b.toDataURL("image/png",1)),c.restore(),this._restore(this.img_curCanvas2)},XF_CANVAS.prototype._restore=function(a){var b,c;b=this.xf_canvas.get(0),c=b.getContext("2d"),c.save(),c.globalCompositeOperation="copy",c.clearRect(0,0,b.width,b.height),c.drawImage(a,0,0,b.width,b.height,0,0,b.width,b.height),c.restore()},XF_CANVAS.prototype.on_object_mousedown=function(a){var b;return factory.registermouseevent(this,a),this.xf_prop.enable&&0!=this.xf_prop.draw_mode?(this.history.saveHistory(this.xf_canvas.get(0)),this.is_mouse_down=!0,b=_xfj.eventpagexy(a),void(2==this.xf_prop.draw_mode?(this.img_curCanvas.src=this.xf_canvas.get(0).toDataURL("image/png",1),this.prev_x=b.x-this.xf_canvas.offset().left,this.prev_y=b.y-this.xf_canvas.offset().top):this._drawline(b.x-this.xf_canvas.offset().left,b.y-this.xf_canvas.offset().top,!0))):void(0==this.xf_prop.click_setfocus&&a.preventDefault())},XF_CANVAS.prototype.on_object_mousemove=function(a){var b;return this.xf_prop.enable?0==this.xf_prop.draw_mode?!1:(b=_xfj.eventpagexy(a),this.is_mouse_down&&(2==this.xf_prop.draw_mode?this._drawstraight(b.x-this.xf_canvas.offset().left,b.y-this.xf_canvas.offset().top,!0):this._drawline(b.x-this.xf_canvas.offset().left,b.y-this.xf_canvas.offset().top,!1)),void a.preventDefault()):!1},XF_CANVAS.prototype.on_object_mouseup=function(a){var b;return this.xf_prop.enable?0==this.xf_prop.draw_mode?!1:(b=_xfj.eventpagexy(a),this.is_mouse_down&&2==this.xf_prop.draw_mode&&this._drawstraight(b.x-this.xf_canvas.offset().left,b.y-this.xf_canvas.offset().top,!1),void(this.is_mouse_down=!1)):!1},XF_CANVAS.prototype.on_object_mouseleave=function(a){return this.xf_prop.enable?(this.is_mouse_down&&2==this.xf_prop.draw_mode&&this._restore(this.img_curCanvas),void(this.is_mouse_down=!1)):!1},XF_CANVAS.prototype.on_object_click=function(a){return this.xf_prop.enable?void factory._fireevent({xf_component:this,event_name:"on_click"},this):!1},XF_CANVAS.prototype.on_imagefile_click=function(a){a.stopPropagation()},XF_CANVAS.prototype.on_imagefile_change=function(a){var b,c;0!=this.xf_image_file.val().length&&(b=this,c=new FileReader,c.readAsDataURL(this.xf_image_file[0].files[0]),c.onload=function(){b._drawimage(c.result,b.img_size,b.img_horzalign,b.img_vertalign)})},XF_CANVAS.prototype.setlinewidth=function(a){return a=_xfu.intval(a),a===!1?!1:(this.xf_prop.line_width=a,this._setdrawinfo(),!0)},XF_CANVAS.prototype.getlinewidth=function(){return this.xf_prop.line_width},XF_CANVAS.prototype.setlinestyle=function(a){return a=_xfu.intval(a,0,4),a===!1?!1:(this.xf_prop.line_style=a,this._setdrawinfo(),!0)},XF_CANVAS.prototype.getlinestyle=function(){return this.xf_prop.line_style},XF_CANVAS.prototype.setlinecolor=function(a){return this.xf_prop.line_color=_xfu.rgb(a),this._setdrawinfo(),!0},XF_CANVAS.prototype.getlinecolor=function(){return this.xf_prop.line_color},XF_CANVAS.prototype.setarrowstyle=function(a){return a=_xfu.intval(a,0,3),a===!1?!1:(this.xf_prop.arrow_style=a,!0)},XF_CANVAS.prototype.getarrowstyle=function(){return this.xf_prop.arrow_style},XF_CANVAS.prototype.seteraserwidth=function(a){return a=_xfu.intval(a),a===!1?!1:(this.xf_prop.eraser_width=a,this._setdrawinfo(),!0)},XF_CANVAS.prototype.geteraserwidth=function(){return this.xf_prop.eraser_width},XF_CANVAS.prototype.setdrawmode=function(a){return a=_xfu.intval(a,0,3),a===!1?!1:(this.xf_prop.draw_mode=a,this._setdrawinfo(),!0)},XF_CANVAS.prototype.getdrawmode=function(){return this.xf_prop.draw_mode},XF_CANVAS.prototype.undocanvas=function(){this.history.undo(this.xf_canvas.get(0),this.xf_canvas.get(0).getContext("2d"))},XF_CANVAS.prototype.redocanvas=function(){this.history.redo(this.xf_canvas.get(0),this.xf_canvas.get(0).getContext("2d"))},XF_CANVAS.prototype.clearcanvas=function(){this.history.saveHistory(this.xf_canvas.get(0)),this.xf_canvas.get(0).getContext("2d").clearRect(0,0,this.xf_canvas.get(0).width,this.xf_canvas.get(0).height)},XF_CANVAS.prototype.saveimage=function(a){var b,c,d;b=this,c=this.xf_canvas.get(0),void 0===a&&(a=!1),1==a?(this.img_curCanvas2.src=c.toDataURL("image/png",1),this.img_curCanvas2.onload=function(){return 0==b.xf_prop.back_image.length?void b._drawbackground(null):(d=new Image,d.style="no-repeat;",d.src=_xfx.imageurl(b.xf_prop.back_image),void(d.onload=function(){b._drawbackground(d)}))}):factory._fireevent({xf_component:b,event_name:"on_saveimage"},b,c.toDataURL("image/png",1))},XF_CANVAS.prototype.insertimage=function(a,b,c,d){void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=0),this.history.saveHistory(this.xf_canvas.get(0)),void 0===a||null==a||0==a.length?(this.img_size=b,this.img_horzalign=c,this.img_vertalign=d,void 0===this.xf_image_file&&(this.xf_image_file=$('<input type="file" accept="image/*" style="display:none;">'),this.xf_object.append(this.xf_image_file),this.xf_image_file.on("change",$.proxy(this.on_imagefile_change,this)),this.xf_image_file.on("click",$.proxy(this.on_imagefile_click,this))),this.xf_image_file[0].value="",this.xf_image_file.get(0).click()):this._drawimage(a,b,c,d)},XF_CANVAS.prototype.getdom=function(){return this.xf_canvas.get(0)},XF_CANVAS.prototype.getjdom=function(){return this.xf_canvas},XF_CANVAS.prototype.getcontext=function(){return this.xf_canvas.get(0).getContext("2d")};